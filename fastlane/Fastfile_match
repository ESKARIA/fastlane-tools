# frozen_string_literal: true

# ==============================================================================
# Fastfile_match - Управление сертификатами и provisioning profiles
# ==============================================================================
# Этот модуль содержит lanes для управления сертификатами и provisioning
# profiles через match. Match хранит все сертификаты в зашифрованном виде
# в git репозитории.
#
# Основные функции:
#   - Генерация сертификатов (development и appstore)
#   - Установка сертификатов локально
#   - Управление provisioning profiles
# ==============================================================================

# ==============================================================================
# ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
# ==============================================================================

# Генерирует новые сертификаты и provisioning profiles через match
#
# Поддерживает несколько bundle identifiers через запятую в APP_IDENTIFIER.
# Пример: "com.app.main,com.app.widget,com.app.watchkit"
#
# @param type [String] тип сертификата: 'development' или 'appstore'
# @param git_branch [String] ветка git репозитория match для хранения сертификатов
# @return [void]
#
# @example
#   # Один идентификатор
#   generate_match(type: 'development', git_branch: 'development')
#
#   # Несколько идентификаторов (через запятую в APP_IDENTIFIER)
#   # APP_IDENTIFIER="com.app.main,com.app.widget"
#   generate_match(type: 'appstore', git_branch: 'distribution')
def generate_match(type:, git_branch:)
  # Валидация обязательных переменных окружения
  raise 'Has no APP_IDENTIFIER' unless APP_IDENTIFIER
  raise 'Has no APPSTORE_KEY_CONTENT' unless APPSTORE_KEY_CONTENT

  # Получение всех bundle identifiers
  # Поддержка нескольких bundle identifiers через запятую
  app_identifiers = if respond_to?(:get_all_app_identifiers)
                      get_all_app_identifiers
                    else
                      APP_IDENTIFIER.to_s.split(',').map(&:strip).reject(&:empty?)
                    end

  UI.user_error!('❌ APP_IDENTIFIER не установлен или пуст') if app_identifiers.empty?

  # Информативный вывод о количестве идентификаторов
  UI.message("Найдено bundle identifiers для match: #{app_identifiers.count}")
  app_identifiers.each_with_index do |identifier, index|
    UI.message("  #{index + 1}. #{identifier}")
  end

  # Match поддерживает как строку с запятыми, так и массив
  # Используем строку с запятыми для совместимости
  app_identifier_param = app_identifiers.join(',')

  # Настройка API ключа App Store Connect для работы с сертификатами
  api_key = app_store_connect_api_key(
    key_id: APPSTORE_KEY_ID,
    issuer_id: APPSTORE_ISSUER_ID,
    key_content: APPSTORE_KEY_CONTENT,
    in_house: false,
    is_key_content_base64: true
  )

  # Генерация сертификатов и профилей через match
  match(type: type,
        app_identifier: app_identifier_param,
        api_key: api_key,
        force_for_new_devices: true,        # Принудительно обновлять при добавлении новых устройств
        include_all_certificates: true,     # Включать все существующие сертификаты
        force_for_new_certificates: true,   # Принудительно создавать новые сертификаты при необходимости
        clone_branch_directly: true,        # Клонировать указанную ветку напрямую
        readonly: false,                    # Режим записи (разрешает создание/обновление)
        fail_on_name_taken: true,           # Ошибка, если имя сертификата уже занято
        force: true,                        # Принудительное обновление существующих сертификатов
        platform: 'ios',
        verbose: true,                      # Подробный вывод информации
        generate_apple_certs: true,         # Генерировать сертификаты в Apple Developer Portal
        git_branch: git_branch)             # Ветка git репозитория для хранения сертификатов
end

# Устанавливает существующие сертификаты и профили из match репозитория
#
# Поддерживает несколько bundle identifiers через запятую в APP_IDENTIFIER.
# Пример: "com.app.main,com.app.widget,com.app.watchkit"
#
# @param type [String] тип сертификата: 'development' или 'appstore'
# @param git_branch [String] ветка git репозитория match
# @return [void]
#
# @example
#   # Один идентификатор
#   match_install(type: 'appstore', git_branch: 'distribution')
#
#   # Несколько идентификаторов (через запятую в APP_IDENTIFIER)
#   # APP_IDENTIFIER="com.app.main,com.app.widget"
#   match_install(type: 'appstore', git_branch: 'distribution')
def match_install(type:, git_branch:)
  # Получение всех bundle identifiers
  # Поддержка нескольких bundle identifiers через запятую
  app_identifiers = if respond_to?(:get_all_app_identifiers)
                      get_all_app_identifiers
                    else
                      APP_IDENTIFIER.to_s.split(',').map(&:strip).reject(&:empty?)
                    end

  UI.user_error!('❌ APP_IDENTIFIER не установлен или пуст') if app_identifiers.empty?

  # Информативный вывод о количестве идентификаторов
  UI.message("Установка сертификатов для bundle identifiers: #{app_identifiers.count}")
  app_identifiers.each_with_index do |identifier, index|
    UI.message("  #{index + 1}. #{identifier}")
  end

  # Match поддерживает как строку с запятыми, так и массив
  # Используем строку с запятыми для совместимости
  app_identifier_param = app_identifiers.join(',')

  # Установка сертификатов и профилей в режиме только чтения
  match(type: type,
        app_identifier: app_identifier_param,
        include_all_certificates: true,      # Включать все существующие сертификаты
        clone_branch_directly: true,         # Клонировать указанную ветку напрямую
        fail_on_name_taken: true,            # Ошибка, если имя сертификата уже занято
        readonly: true,                      # Режим только чтения (не создает новые сертификаты)
        force: false,                        # Не принуждать обновление
        platform: 'ios',
        verbose: true,                       # Подробный вывод информации
        git_branch: git_branch)              # Ветка git репозитория
end

# ==============================================================================
# LANES ДЛЯ ГЕНЕРАЦИИ СЕРТИФИКАТОВ
# ==============================================================================

# Генерирует development сертификаты и provisioning profiles
#
# Используется для:
#   - Первой настройки проекта
#   - Добавления новых устройств для разработки
#   - Обновления списка устройств
#
# @example
#   fastlane match_generate_dev
desc 'Generate development certificates and provisioning profiles'
lane :match_generate_dev do |_options|
  # Валидация наличия API ключа App Store Connect
  raise 'Has no APPSTORE_KEY_CONTENT' unless APPSTORE_KEY_CONTENT

  # Генерация development сертификатов в ветке 'development'
  generate_match(type: 'development', git_branch: 'development')
end

# Генерирует App Store сертификаты и provisioning profiles
#
# Используется для:
#   - Первой сборки для App Store
#   - Обновления сертификатов для публикации
#
# @example
#   fastlane match_generate_appstore
desc 'Generate App Store certificates and provisioning profiles'
lane :match_generate_appstore do |_options|
  # Валидация наличия API ключа App Store Connect
  raise 'Has no APPSTORE_KEY_CONTENT' unless APPSTORE_KEY_CONTENT

  # Генерация App Store сертификатов в ветке 'distribution'
  generate_match(type: 'appstore', git_branch: 'distribution')
end

# ==============================================================================
# LANES ДЛЯ УСТАНОВКИ СЕРТИФИКАТОВ
# ==============================================================================

# Устанавливает development сертификаты и профили локально
#
# Используется для:
#   - Настройки нового компьютера разработчика
#   - Восстановления сертификатов после сбоев
#   - Перед локальной разработкой
#
# @example
#   fastlane match_install_dev
desc 'Install development certificates and provisioning profiles'
lane :match_install_dev do |_options|
  # Установка development сертификатов из ветки 'development'
  match_install(type: 'development', git_branch: 'development')
end

# Устанавливает App Store сертификаты и профили локально
#
# Используется для:
#   - Настройки CI/CD окружения
#   - Перед сборкой для App Store
#   - Восстановления сертификатов
#
# @example
#   fastlane match_install_appstore
desc 'Install App Store certificates and provisioning profiles'
lane :match_install_appstore do |_options|
  # Валидация наличия API ключа (может потребоваться для некоторых операций)
  raise 'Has no APPSTORE_KEY_CONTENT' unless APPSTORE_KEY_CONTENT

  # Установка App Store сертификатов из ветки 'distribution'
  match_install(type: 'appstore', git_branch: 'distribution')
end

# ==============================================================================
# УТИЛИТЫ
# ==============================================================================

# Полностью удаляет все сертификаты и профили (разрушительная операция)
#
# ⚠️ ВНИМАНИЕ: Это необратимое действие!
# Используется только при необходимости полностью очистить все сертификаты.
# После выполнения потребуется перегенерировать все сертификаты.
#
# @example
#   fastlane nuke_all
desc 'Nuke (delete) all certificates and provisioning profiles'
lane :nuke_all do |_options|
  # Получение всех bundle identifiers
  app_identifiers = if respond_to?(:get_all_app_identifiers)
                      get_all_app_identifiers
                    else
                      APP_IDENTIFIER.to_s.split(',').map(&:strip).reject(&:empty?)
                    end

  UI.user_error!('❌ APP_IDENTIFIER не установлен или пуст') if app_identifiers.empty?

  app_identifier_param = app_identifiers.join(',')

  UI.important("⚠️  Удаление сертификатов для #{app_identifiers.count} bundle identifier(s)")

  # Удаление development сертификатов и профилей
  match(type: 'development',
        app_identifier: app_identifier_param,
        git_branch: 'development',
        skip_confirmation: true,           # Пропуск подтверждения (опасно!)
        safe_remove_certs: false)          # Небезопасное удаление (удаляет даже используемые)

  # Удаление App Store сертификатов и профилей
  match(type: 'appstore',
        app_identifier: app_identifier_param,
        git_branch: 'distribution',
        skip_confirmation: true, # Пропуск подтверждения
        safe_remove_certs: false) # Небезопасное удаление
end

# Полностью перегенерирует все сертификаты и профили
#
# Используется для:
#   - Обновления всех сертификатов при подозрении на проблемы
#   - Синхронизации после конфликтов в match репозитории
#
# ⚠️ ВНИМАНИЕ: Это действие удалит и пересоздаст все сертификаты.
# Используйте с осторожностью!
#
# @example
#   fastlane reset_all_profiles
desc 'Reset (regenerate) all certificates and provisioning profiles'
lane :reset_all_profiles do
  # Валидация обязательных переменных
  raise 'Has no APP_IDENTIFIER' unless APP_IDENTIFIER
  raise 'Has no APPSTORE_KEY_CONTENT' unless APPSTORE_KEY_CONTENT

  # Получение всех bundle identifiers
  app_identifiers = if respond_to?(:get_all_app_identifiers)
                      get_all_app_identifiers
                    else
                      APP_IDENTIFIER.to_s.split(',').map(&:strip).reject(&:empty?)
                    end

  UI.user_error!('❌ APP_IDENTIFIER не установлен или пуст') if app_identifiers.empty?

  app_identifier_param = app_identifiers.join(',')

  UI.message("Перегенерация сертификатов для bundle identifiers: #{app_identifiers.count}")
  app_identifiers.each_with_index do |identifier, index|
    UI.message("  #{index + 1}. #{identifier}")
  end

  # Настройка API ключа App Store Connect
  api_key = app_store_connect_api_key(
    key_id: APPSTORE_KEY_ID,
    issuer_id: APPSTORE_ISSUER_ID,
    key_content: APPSTORE_KEY_CONTENT,
    in_house: false,
    is_key_content_base64: true
  )

  # Перегенерация development сертификатов и профилей
  match(type: 'development',
        app_identifier: app_identifier_param,
        api_key: api_key,
        force_for_new_devices: true, # Обновлять при добавлении устройств
        include_all_certificates: true, # Включать все сертификаты
        force_for_new_certificates: true,   # Принудительно создавать новые
        clone_branch_directly: true,
        readonly: false,                    # Режим записи
        fail_on_name_taken: true,
        force: true,                        # Принудительное обновление
        platform: 'ios',
        verbose: true,
        generate_apple_certs: true,
        git_branch: 'development')

  # Перегенерация App Store сертификатов и профилей
  match(type: 'appstore',
        app_identifier: app_identifier_param,
        api_key: api_key,
        force_for_new_devices: true,
        include_all_certificates: true,
        force_for_new_certificates: true,
        clone_branch_directly: true,
        readonly: false,
        fail_on_name_taken: true,
        force: true,
        platform: 'ios',
        verbose: true,
        generate_apple_certs: true,
        git_branch: 'distribution')

  # Сообщение об успешном завершении
  UI.success('✅ Все сертификаты и профили обновлены.')
end
