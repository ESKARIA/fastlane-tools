# frozen_string_literal: true

desc 'Upload symbols'
lane :upload_dsyms do |options|
  if UPLOAD_DSYMS_ENABLED
    UI.header('Загрузка символов (dSYM)')
  else
    UI.message('⚠️  Загрузка dSYM отключена (UPLOAD_DSYMS=false)')
    return
  end

  check_and_set_project_file

  is_metrica = !HELPER_PATH.nil? && !HELPER_PATH.empty?

  if is_metrica
    UI.message("Путь к helper: #{HELPER_PATH}")
    UI.message('Загрузка dSYM в AppMetrica...')
    sh('chmod +x ./helper') if File.exist?('./helper')
    unzip_and_upload(options)
  else
    UI.message('Пропуск загрузки в AppMetrica: путь к helper не настроен')
  end

  firebase = options[:firebase] ? true : false
  if firebase
    UI.message('Загрузка dSYM в Firebase Crashlytics...')
    require 'find'
    dsym_paths = []
    Find.find('.') do |path|
      dsym_paths << path if path.end_with?('.dSYM.zip')
    end

    if dsym_paths.empty?
      UI.message('⚠️  Не найдено dSYM файлов для загрузки в Firebase')
    else
      UI.message("Найдено dSYM файлов: #{dsym_paths.count}")
      upload_symbols_to_crashlytics(dsym_paths: dsym_paths)
      UI.success('✅ dSYM успешно загружены в Firebase')
    end
  end
end

lane :unzip_and_upload do |_options|
  require 'fileutils'
  require 'find'
  check_and_set_project_file

  dsym_paths = []
  UI.message('Поиск *.dSYM.zip файлов...')
  Find.find('.') do |path|
    dsym_paths << path if path.end_with?('.dSYM.zip')
  end

  if dsym_paths.empty?
    UI.message('⚠️  Не найдено dSYM.zip файлов')
    return
  end

  UI.message("Найдено dSYM.zip файлов: #{dsym_paths.count}")

  dsym_paths.each do |zip_file|
    if File.exist?(zip_file)
      UI.message("Обработка: #{zip_file}")
      UI.message('Распаковка архива...')
      sh("unzip -o -q #{zip_file}") # -q для тихого режима
      UI.message('Распаковка завершена')

      if File.exist?(HELPER_PATH)
        UI.message('Загрузка dSYM через helper скрипт...')
        sh("#{HELPER_PATH} -k #{APPMETRICA_KEY} -v")
        UI.success("✅ dSYM загружен: #{zip_file}")
      else
        UI.user_error!("Helper скрипт не найден: #{HELPER_PATH}")
      end
    else
      UI.message("⚠️  Файл не найден: #{zip_file}")
    end
  end
end
