desc "Upload ipa to AppStore Connect TestFlight"
lane :upload_testflight do |options|
    toExternal = options[:public]

    api_key = app_store_connect_api_key(key_id: APPSTORE_KEY_ID,
        issuer_id: APPSTORE_ISSUER_ID,
        key_content: APPSTORE_KEY_CONTENT,
        in_house: false,
        is_key_content_base64: true)

    changelog = changelog_from_git_commits(
        commits_count: 10,
        pretty: "[%an] - %s",
        merge_commit_filtering: "exclude_merges"
    )
    app_identifier = ENV["APP_IDENTIFIER"].split(',').first

    UI.message("[DEBUG]: Start deploy")
    if (toExternal == true)
        changelog = "Fixes bugs, improvements UI, new features"
        UI.message("[DEBUG]: External Public Beta")
        testflight(api_key: api_key, 
            app_identifier: app_identifier,
            changelog: changelog.to_s, 
            distribute_external: true, 
            groups: "External Public Beta",
            skip_waiting_for_build_processing: false, 
            expire_previous_builds: false,
            ipa: IPA_FILE_PATH.to_s)
    else
        UI.message("[DEBUG]: NO deploy to External Public Beta")
        testflight(api_key: api_key, 
            app_identifier: app_identifier,
            changelog: changelog.to_s, 
            distribute_external: false, 
            skip_waiting_for_build_processing: false, 
            expire_previous_builds: false,
            ipa: IPA_FILE_PATH.to_s)
    end
    UI.message("[DEBUG]: Complete deploy")

end