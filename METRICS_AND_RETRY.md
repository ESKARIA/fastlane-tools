# üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ Retry –ª–æ–≥–∏–∫–∞

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è lanes –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç retry –ª–æ–≥–∏–∫—É –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

---

## üîÑ Retry –ª–æ–≥–∏–∫–∞

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç —Å–µ—Ç–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö:

- **–ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫:** 3
- **–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏:** –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è (5 —Å–µ–∫, 10 —Å–µ–∫, 20 —Å–µ–∫)
- **–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫:** –ó–∞–≥—Ä—É–∑–∫–∞–º –≤ TestFlight, –æ–ø–µ—Ä–∞—Ü–∏—è–º —Å App Store Connect

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```ruby
retry_with_backoff(max_retries: 3, delay: 5.0) do
  testflight(...)
end
```

### –õ–æ–≥–∏ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–∞—Ö

```
–ü–æ–ø—ã—Ç–∫–∞ 1/3...
‚ö†Ô∏è  –û—à–∏–±–∫–∞ (–ø–æ–ø—ã—Ç–∫–∞ 1/3): Connection timeout
–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 5.0 —Å–µ–∫—É–Ω–¥...
–ü–æ–ø—ã—Ç–∫–∞ 2/3...
‚úÖ –£—Å–ø–µ—à–Ω–æ!
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ retry

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

```ruby
retry_with_backoff(max_retries: 5, delay: 10.0) do
  # –≤–∞—à –∫–æ–¥
end
```

### –û—à–∏–±–∫–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –ø–æ–≤—Ç–æ—Ä–∞

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è:
- Timeout –æ—à–∏–±–∫–∏
- Network errors
- Connection errors
- Service unavailable (503)
- Rate limit (429)
- Internal server error (500)

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫

–ú–µ—Ç—Ä–∏–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö lanes:

**–ß—Ç–æ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è:**
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è lane
- –í–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- Build number
- –†–∞–∑–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤ (IPA, dSYM)
- –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (success/failed)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫

–ú–µ—Ç—Ä–∏–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ñ–∞–π–ª `fastlane/metrics.json`:

```json
[
  {
    "lane": "build",
    "timestamp": "2024-01-15T10:30:00+03:00",
    "metrics": {
      "version": "1.2.3",
      "build_number": "456",
      "ipa_size_mb": 125.5,
      "ipa_size_gb": 0.123,
      "dsym_size_mb": 15.2,
      "duration_seconds": 1250.5,
      "duration_formatted": "20 –º–∏–Ω 50 —Å–µ–∫",
      "status": "success"
    }
  }
]
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫

#### –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ—Ç—Ä–∏–∫

```bash
cat fastlane/metrics.json | jq
```

#### –ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ —Å–±–æ—Ä–∫–∏

```bash
cat fastlane/metrics.json | jq '.[] | select(.lane == "build") | .metrics.duration_seconds'
```

#### –¢—Ä–µ–Ω–¥—ã —Ä–∞–∑–º–µ—Ä–æ–≤ IPA

```bash
cat fastlane/metrics.json | jq '.[] | select(.lane == "build") | .metrics.ipa_size_mb'
```

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫

```ruby
lane :my_lane do
  add_metric("custom_metric", "value")
  add_metric("another_metric", 123)
end
```

#### –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫

```ruby
lane :my_lane do
  start_metrics('my_lane')
  # –≤–∞—à –∫–æ–¥
  finish_metrics(send_to_telegram: true, save_to_file: true)
end
```

### –ú–µ—Ç—Ä–∏–∫–∏ –≤ Telegram

–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram, –º–µ—Ç—Ä–∏–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è lane:

```
üìä –ú–µ—Ç—Ä–∏–∫–∏: build

version: 1.2.3
build_number: 456
ipa_size_mb: 125.5
ipa_size_gb: 0.123
duration_seconds: 1250.5
duration_formatted: 20 –º–∏–Ω 50 —Å–µ–∫
status: success
```

---

## üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ lanes

### Build lane

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –º–µ—Ç—Ä–∏–∫–∏:
- –í–µ—Ä—Å–∏—è
- Build number
- –†–∞–∑–º–µ—Ä IPA
- –†–∞–∑–º–µ—Ä dSYM
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### Upload TestFlight lane

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –º–µ—Ç—Ä–∏–∫–∏:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –ü—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ retry –ª–æ–≥–∏–∫–∏

---

## üìà –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ò—Å—Ç–æ—Ä–∏—è –º–µ—Ç—Ä–∏–∫

–§–∞–π–ª `fastlane/metrics.json` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –∑–∞–ø–∏—Å–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:

```bash
# –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏
cat fastlane/metrics.json | jq '[.[] | select(.lane == "build") | .metrics.duration_seconds] | add / length'

# –¢—Ä–µ–Ω–¥ —Ä–∞–∑–º–µ—Ä–æ–≤ IPA
cat fastlane/metrics.json | jq '[.[] | select(.lane == "build") | .metrics.ipa_size_mb] | .[-10:]'
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–ú–µ—Ç—Ä–∏–∫–∏ –º–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤:
- Grafana
- Prometheus
- Datadog
- –î—Ä—É–≥–∏–µ —Å–∏—Å—Ç–µ–º—ã

–ü—Ä–∏–º–µ—Ä —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞:

```ruby
require 'json'

metrics = JSON.parse(File.read('fastlane/metrics.json'))
# –≠–∫—Å–ø–æ—Ä—Ç –≤ –≤–∞—à—É —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫:

```ruby
# –í Fastfile —É–±—Ä–∞—Ç—å –≤—ã–∑–æ–≤—ã start_metrics –∏ finish_metrics
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –º–µ—Ç—Ä–∏–∫

```ruby
finish_metrics(save_to_file: true)
# –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ fastlane/metrics.json
```

### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram

```bash
export TELEGRAM_ENABLED="false"
```

---

## üêõ Troubleshooting

### –ú–µ—Ç—Ä–∏–∫–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `fastlane/`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ helpers –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã: `require_relative 'Fastfile_helpers'`

### Retry –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `retry_with_backoff` –¥–æ—Å—Ç—É–ø–Ω–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ helpers –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã

### –û—à–∏–±–∫–∏ –≤ –º–µ—Ç—Ä–∏–∫–∞—Ö

–ï—Å–ª–∏ –º–µ—Ç—Ä–∏–∫–∏ –Ω–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è, —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å. –ú–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- –ú–µ—Ç—Ä–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
- –ò—Å—Ç–æ—Ä–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ 100 –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ –∑–∞–ø–∏—Å—è–º–∏
- –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –≤–∫–ª—é—á–∞—é—Ç timestamp –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤

